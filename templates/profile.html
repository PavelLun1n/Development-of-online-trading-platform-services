<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Профиль</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
    <div class="header-container">
        <h1>Профиль</h1>
        <div class="header-actions">
            <a href="/" class="home-link">На главную</a>
            <a href="/logout" class="login-link">Выйти</a>
        </div>
    </div>
</header>
<main>
    <section class="profile-info">
        <h2>Основная информация</h2>
        <div class="info-grid">
            <p><strong>Имя пользователя:</strong> <span th:text="${user.username}"></span></p>
            <p><strong>Email:</strong> <span th:text="${user.email}"></span></p>
            <p><strong>Дата регистрации:</strong> <span th:text="${#temporals.format(user.registrationDate, 'dd.MM.yyyy')}"></span></p>
            <p><strong>Рейтинг:</strong> <span th:text="${user.rating}"></span></p>
            <p><strong>Баланс:</strong> <span th:text="${user.balance} + ' ₽'"></span></p>
        </div>
    </section>

    <section class="orders-section">
        <h2>История заказов</h2>
        <div class="orders-grid">
            <div th:each="order : ${orders}" class="order-card">
                <div class="order-header">
                    <span th:text="'Заказ #' + ${order.id}"></span>
                    <span class="order-date" th:text="${#temporals.format(order.orderDate, 'dd.MM.yyyy HH:mm')}"></span>
                </div>
                <div class="order-details">
                    <p><strong>Товар:</strong> <span th:text="${order.productName}"></span></p>
                    <p><strong>Количество:</strong> <span th:text="${order.quantity}"></span></p>
                    <p><strong>Сумма:</strong> <span th:text="${order.totalPrice} + ' ₽'"></span></p>
                    <p><strong>Статус:</strong> <span th:class="'order-status ' + ${order.status.toString().toLowerCase()}" th:text="${order.statusMessage}"></span></p>
                </div>
            </div>
        </div>
    </section>

    <section class="viewed-products-section">
        <h2>Просмотренные товары</h2>
        <div class="products-grid">
            <div th:each="action : ${viewedProducts}" class="product-card">
                <div th:if="${action.product != null and action.product.imageUrl != null}" class="image-wrapper">
                    <img th:src="${action.product.imageUrl}" class="product-image" alt="Product Image" />
                </div>
                <div class="product-details">
                    <p><strong>Товар:</strong> <a th:href="@{'/products/' + ${action.product.id}}" th:text="${action.product.name != null ? action.product.name : 'Название недоступно'}"></a></p>
                    <p><strong>Цена:</strong> <span th:text="${action.product.price != null ? action.product.price + ' ₽' : 'N/A'}"></span></p>
                </div>
            </div>
        </div>
    </section>

    <section class="product-stats-section">
        <h2>Статистика по товарам</h2>
        <form method="get" action="/profile">
            <label for="startDate">Начальная дата:</label>
            <input type="date" id="startDate" name="startDate" th:value="${startDate}" />
            <label for="endDate">Конечная дата:</label>
            <input type="date" id="endDate" name="endDate" th:value="${endDate}" />
            <button type="submit">Показать</button>
        </form>
        <div th:if="${not #lists.isEmpty(topViewedProducts)}">
            <h3>Топ-5 просмотренных товаров</h3>
            <ul>
                <li th:each="product : ${topViewedProducts}">
                    <strong>Товар:</strong> <span th:text="${product.name}"></span><br>
                    <strong>Цена:</strong> <span th:text="${product.price} + ' ₽'"></span><br>
                    <strong>Просмотры:</strong> <span th:text="${product.viewCount}"></span>
                </li>
            </ul>
        </div>
        <div th:if="${#lists.isEmpty(topViewedProducts)}">
            <p>Нет данных о просмотрах товаров за выбранный период.</p>
        </div>
        <div th:if="${not #maps.isEmpty(viewsByDay)}">
            <canvas id="viewsChart" width="400" height="200"></canvas>
            <script>
                var ctx = document.getElementById('viewsChart').getContext('2d');
                var viewsByDay = /*[[${viewsByDay}]]*/ {};
                var labels = Object.keys(viewsByDay);
                var data = Object.values(viewsByDay);
                var chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Просмотры по дням',
                            data: data,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            </script>
        </div>
        <div th:if="${#lists.isEmpty(orders)}">
            <p>Нет данных о заказах за выбранный период.</p>
        </div>
    </section>
</main>
<footer>
    <p>© 2025 Интернет-магазин</p>
</footer>
</body>
</html>